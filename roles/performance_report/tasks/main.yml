---
- name: Collect system metrics
  ansible.builtin.set_fact:
    monitoring_result:
      hostname: "{{ inventory_hostname }}"
      ip: "{{ ansible_default_ipv4.address }}"
      os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
      cpu_cores: "{{ ansible_processor_vcpus }}"
      memory_total_mb: "{{ ansible_memtotal_mb }}"
      memory_used_mb: "{{ ansible_memtotal_mb - ansible_memfree_mb }}"
      disk_total_gb: "{{ (ansible_mounts | selectattr('mount','equalto','/') | map(attribute='size_total') | first / 1073741824) | round(2) }}"
      disk_free_gb: "{{ (ansible_mounts | selectattr('mount','equalto','/') | map(attribute='size_available') | first / 1073741824) | round(2) }}"

- name: Ensure reports directory exists (local)
  ansible.builtin.file:
    path: "{{ playbook_dir }}/reports"
    state: directory
    mode: "0755"
  delegate_to: localhost
  run_once: true

- name: Generate consolidated HTML report
  ansible.builtin.template:
    src: report.html.j2
    dest: "{{ report_output_path }}"
  delegate_to: localhost
  run_once: true
