---
- name: Collect System Metrics
  ansible.builtin.set_fact:
    performance_report_monitoring_result:
      hostname: "{{ inventory_hostname }}"
      ip: "{{ ansible_facts['default_ipv4']['address'] }}"
      os: "{{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}"
      cpu_cores: "{{ ansible_facts['processor_vcpus'] }}"
      memory_total_mb: "{{ ansible_facts['memtotal_mb'] }}"
      memory_used_mb: "{{ ansible_facts['memtotal_mb'] - ansible_facts['memfree_mb'] }}"
      disk_total_gb: >-
        {{ (
            ansible_facts['mounts']
            | selectattr('mount', 'equalto', '/')
            | map(attribute='size_total')
            | first
            / 1073741824
          ) | round(2) }}
      disk_free_gb: >-
        {{ (
            ansible_facts['mounts']
            | selectattr('mount', 'equalto', '/')
            | map(attribute='size_available')
            | first
            / 1073741824
          ) | round(2) }}

- name: Ensure Reports Directory Exists
  ansible.builtin.file:
    path: "{{ playbook_dir }}/reports"
    state: directory
    mode: "0755"
  delegate_to: localhost
  run_once: true

- name: Generate Consolidated HTML Report
  ansible.builtin.template:
    src: report.html.j2
    dest: "{{ performance_report_output_path }}"
    mode: "0644"
  delegate_to: localhost
  run_once: true
